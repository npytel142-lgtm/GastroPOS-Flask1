<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administratora - GastroPOS</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        
        /* NOWE STYLE DLA NAGŁÓWKA Z PRZYCISKIEM WYLOGUJ */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 10px;
            border-bottom: 2px solid #008CBA;
        }
        .logout-btn { 
            background-color: #F44336; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            text-decoration: none; 
            font-weight: bold;
        }
        /* KONIEC NOWYCH STYLÓW */

        h1 { color: #333; margin: 0; }
        h2 { color: #008CBA; margin-top: 30px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .tab-buttons button { padding: 10px 20px; margin-right: 10px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 5px 5px 0 0; }
        .tab-buttons button.active { background: #008CBA; color: white; border-color: #008CBA; }
        
        /* Sekcja raportu */
        .report-form { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; }
        .report-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .report-form input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .report-form button { background-color: #4CAF50; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .report-form button:hover { background-color: #45a049; }

        /* Tabela podsumowania */
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .summary-table th, .summary-table td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        .summary-table th { background-color: #008CBA; color: white; }
        .summary-table tr:nth-child(even) { background-color: #f2f2f2; }
        
        /* Sekcja dodawania menu */
        .add-menu-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .add-menu-form label { display: block; margin-bottom: 5px; font-weight: bold; }
        .add-menu-form input, .add-menu-form select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .add-menu-form button { 
            grid-column: 1 / 3; 
            background-color: #FFC107; 
            color: #333; 
            padding: 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1.1em;
        }
        .add-menu-form button:hover { background-color: #e0b000; }
        
        /* Komunikat */
        .message-box { 
            padding: 10px; 
            margin-top: 20px; 
            border-radius: 4px; 
            font-weight: bold; 
            text-align: center;
            display: none; /* Domyślnie ukryte */
        }
        
    </style>
</head>
<body>
    <div class="container">
        
        <div class="header">
            <h1>Panel Administratora - GastroPOS</h1>
            <a href="{{ url_for('logout') }}" class="logout-btn">Wyloguj (9999)</a>
        </div>
        
        <div class="tab-buttons">
            <button class="active" onclick="openTab('billing')">Podsumowanie Kelnerów</button>
            <button onclick="openTab('menu')">Edycja Menu</button>
        </div>

        <div id="billing" class="tab active">
            <h2>Generowanie Raportu Sprzedaży</h2>
            
            <form id="report-form" class="report-form">
                <div>
                    <label for="start_date">Data początkowa:</label>
                    <input type="date" id="start_date" name="start_date" required>
                </div>
                <div>
                    <label for="end_date">Data końcowa:</label>
                    <input type="date" id="end_date" name="end_date" required>
                </div>
                <button type="submit">Generuj PDF i Wyświetl</button>
            </form>
            
            <h2>Podsumowanie Sprzedaży</h2>
            
            <table class="summary-table" id="waiter-summary-table">
                <thead>
                    <tr>
                        <th>Kelner (ID)</th>
                        <th>Liczba Rachunków</th>
                        <th>Całkowita Sprzedaż (PLN)</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            
        </div>

        <div id="menu" class="tab">
            <h2>Dodaj Nową Pozycję Menu</h2>
            <div id="add-menu-message" class="message-box"></div>
            <form id="add-menu-form" class="add-menu-form">
                <div>
                    <label for="name">Nazwa Produktu:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div>
                    <label for="price">Cena (PLN):</label>
                    <input type="text" id="price" name="price" placeholder="np. 15.50" required>
                </div>
                <div style="grid-column: 1 / 3;">
                    <label for="category">Kategoria:</label>
                    <select id="category" name="category" required>
                        </select>
                </div>
                <button type="submit">Dodaj do Menu</button>
            </form>
        </div>

    </div>

    <script>
        const tableBody = document.querySelector('#waiter-summary-table tbody');
        const categorySelect = document.getElementById('category');
        
        // Funkcja do otwierania zakładek
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            const buttons = document.querySelectorAll('.tab-buttons button');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes(tabName.toLowerCase())) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        // Funkcja do pobierania podsumowania kelnerów
        async function fetchWaiterSummary(startDate, endDate) {
            try {
                const url = `{{ url_for('api_get_waiter_summary') }}?start_date=${startDate}&end_date=${endDate}`;
                const response = await fetch(url);
                const summary = await response.json();

                tableBody.innerHTML = ''; // Wyczyść tabelę
                
                if (summary.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">Brak danych w wybranym okresie.</td></tr>';
                    return;
                }

                summary.forEach(item => {
                    const row = tableBody.insertRow();
                    row.insertCell().textContent = `${item.waiter_name} (${item.waiter_id})`;
                    row.insertCell().textContent = item.orders_count;
                    row.insertCell().textContent = item.total_sales.toFixed(2);
                });

            } catch (error) {
                console.error('Błąd pobierania podsumowania:', error);
                tableBody.innerHTML = '<tr><td colspan="3" style="color: red; text-align: center;">Błąd ładowania danych.</td></tr>';
            }
        }
        
        // Ustawienie domyślnych dat (dziś)
        function setInitialDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('start_date').value = today;
            document.getElementById('end_date').value = today;
            // Załaduj dane na start
            fetchWaiterSummary(today, today);
        }

        // Obsługa formularza raportu
        document.getElementById('report-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const start_date = document.getElementById('start_date').value;
            const end_date = document.getElementById('end_date').value;

            // Wyświetlenie podsumowania na ekranie
            fetchWaiterSummary(start_date, end_date);
            
            // Pobranie i wyświetlenie PDF (otwarcie w nowej karcie)
            const pdfUrl = `{{ url_for('generate_report') }}?start_date=${start_date}&end_date=${end_date}`;
            window.open(pdfUrl, '_blank');
        });
        
        // Funkcja do pobierania kategorii menu
        async function fetchCategories() {
            try {
                const response = await fetch('{{ url_for('api_get_categories') }}');
                const categories = await response.json();
                
                categorySelect.innerHTML = ''; // Wyczyść
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });

            } catch (error) {
                console.error('Błąd pobierania kategorii:', error);
            }
        }

        // Obsługa formularza dodawania menu
        document.getElementById('add-menu-form').onsubmit = async function(e) {
            e.preventDefault();
            const form = e.target;
            const messageDiv = document.getElementById('add-menu-message');
            
            const category = form.category.value;
            
            // Walidacja ceny
            const priceValue = form.price.value.replace(',', '.');
            if (isNaN(parseFloat(priceValue))) {
                 messageDiv.textContent = 'Cena musi być liczbą.';
                 messageDiv.style.display = 'block';
                 return;
            }

            const formData = new FormData();
            formData.append('name', form.name.value);
            formData.append('price', priceValue); 
            formData.append('category', category);

            const response = await fetch('{{ url_for("api_add_item_admin") }}', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            messageDiv.textContent = result.message;
            messageDiv.style.display = 'block';
            
            if (result.success) {
                messageDiv.style.backgroundColor = '#d4edda'; // Zielony
                messageDiv.style.color = '#155724';
                // Odświeżenie, aby nowa kategoria/pozycja pojawiła się
                setTimeout(() => window.location.reload(), 1500); 
            } else {
                messageDiv.style.backgroundColor = '#f8d7da'; // Czerwony
                messageDiv.style.color = '#721c24';
            }
        };

        // Domyślnie otwórz pierwszą zakładkę i załaduj dane
        document.addEventListener('DOMContentLoaded', () => {
             openTab('billing');
             setInitialDates();
             fetchCategories();
        });
        
        // Upewnienie się, że tablica podsumowania odświeża się co 60 sekund
        setInterval(() => {
             const start_date = document.getElementById('start_date').value;
             const end_date = document.getElementById('end_date').value;
             fetchWaiterSummary(start_date, end_date);
        }, 60000); // 60 sekund
    </script>
</body>
</html>
